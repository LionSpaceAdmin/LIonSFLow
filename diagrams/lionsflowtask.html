<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>קנבס אינטראקטיבי: הקמת Flowise Control Plane</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-blue: #3b82f6;
            --brand-green: #22c55e;
            --brand-gray: #e5e7eb;
            --brand-dark-gray: #6b7280;
            --text-dark: #1f2937;
            --canvas-bg: #f9fafb;
            --dot-color: #e5e7eb;
        }
        html, body {
            overscroll-behavior: none;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        body {
            font-family: 'Assistant', sans-serif;
            color: var(--text-dark);
        }
        #canvas-container {
            width: 100%;
            height: 100%;
            background-color: var(--canvas-bg);
            background-image: radial-gradient(var(--dot-color) 1px, transparent 0);
            background-size: 20px 20px;
            cursor: grab;
        }
        #canvas-container:active {
            cursor: grabbing;
        }
        #canvas-viewport {
            width: 100%;
            height: 100%;
            position: relative;
            transform-origin: 0 0;
            transition: transform 0.2s; /* For zoom */
        }
        #connector-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: visible;
        }
        .connector-path {
            stroke: var(--brand-gray);
            stroke-width: 3;
            fill: none;
            transition: stroke 0.5s ease;
        }
        .connector-path.active {
            stroke: url(#active-gradient);
            stroke-dasharray: 10;
            animation: dash 1s linear infinite;
        }
        @keyframes dash { to { stroke-dashoffset: -20; } }

        .step-node {
            background-color: white;
            border: 2px solid var(--brand-gray);
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.08);
            padding: 1.5rem;
            width: 380px;
            position: absolute;
            user-select: none;
            transition: all 0.4s ease-out;
            cursor: grab;
        }
        .step-node.dragging {
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            transform: scale(1.02);
            z-index: 10;
            cursor: grabbing;
        }
        .step-node.active {
            border-color: var(--brand-blue);
            box-shadow: 0 10px 15px rgba(59, 130, 246, 0.1), 0 4px 6px rgba(59, 130, 246, 0.08);
        }
        .step-node.completed {
            border-color: var(--brand-green);
        }
        .step-node-final {
            border-style: dashed;
            text-align: center;
        }

        .step-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f3f4f6; padding-bottom: 1rem; margin-bottom: 1rem; }
        .step-title-section { display: flex; align-items: center; gap: 1rem; }
        .step-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background-color: var(--brand-gray); color: var(--brand-dark-gray); transition: all 0.3s ease; }
        .active .step-icon { background-color: var(--brand-blue); color: white; }
        .completed .step-icon { background-color: var(--brand-green); color: white; }
        .step-title { font-size: 1.5rem; font-weight: 700; }
        .step-status { font-weight: 600; padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.8rem; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-active { background-color: #dbeafe; color: #1e40af; }
        .status-completed { background-color: #dcfce7; color: #166534; }

        .progress-bar-container { background-color: #e5e7eb; border-radius: 99px; overflow: hidden; height: 8px; }
        .progress-bar { background-color: var(--brand-blue); height: 100%; width: 0%; transition: width 0.3s ease; }
        .completed .progress-bar { background-color: var(--brand-green); }

        .checklist-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 0.5rem; }
        .checklist-item input { accent-color: var(--brand-blue); width: 1.1rem; height: 1.1rem; cursor: pointer; }
        .checklist-item label { transition: all 0.2s; cursor: pointer; }
        .checklist-item input:checked + label { text-decoration: line-through; color: #9ca3af; }

        .step-actions { display: flex; gap: 1rem; margin-top: 1.5rem; border-top: 1px solid #f3f4f6; padding-top: 1.5rem; }
        .action-btn { padding: 0.6rem 1.2rem; border-radius: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease; border: 1px solid transparent; cursor: pointer; }
        .btn-guidance { background-color: #e0f2fe; color: #0c4a6e; } .btn-guidance:hover { background-color: #bae6fd; }
        .btn-terminal { background-color: #374151; color: white; } .btn-terminal:hover { background-color: #1f2937; }
        .btn-complete { background-color: var(--brand-gray); color: var(--text-dark); width: 100%; justify-content: center; }
        .btn-complete:not(:disabled):hover { background-color: #d1d5db; }
        .btn-complete:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-complete.ready { background-color: var(--brand-green); color: white; }
        .btn-complete.ready:hover { background-color: #16a34a; }

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { position: relative; background-color: white; border-radius: 1.5rem; padding: 2rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: all 0.3s ease; }
        .visible .modal-content { transform: scale(1); }
        .modal-header { font-size: 1.75rem; font-weight: 700; margin-bottom: 1.5rem; }
        .code-block { background-color: #1f2937; color: #d1d5db; padding: 1.5rem; border-radius: 1rem; direction: ltr; text-align: left; position: relative; }
        .copy-btn { position: absolute; top: 1rem; right: 1rem; background-color: #4b5563; color: white; border: none; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; }
        .guidance-svg { border-radius: 0.75rem; margin: 1rem auto; display: block; max-width: 100%; border: 1px solid #e5e7eb; padding: 1rem; }

        /* Gemini Features Styling */
        .gemini-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px dashed var(--brand-gray);
        }
        .gemini-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #6d28d9; /* Indigo */
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .gemini-btn {
            background-color: #ede9fe; /* Violet 100 */
            color: #5b21b6; /* Violet 800 */
            border: 1px solid #ddd6fe;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .gemini-btn:hover {
            background-color: #ddd6fe;
        }
        .gemini-response-container {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f5f3ff; /* Violet 50 */
            border-radius: 0.75rem;
            border: 1px solid #ede9fe;
            display: none;
            direction: rtl;
            text-align: right;
            white-space: pre-wrap; /* Allows line breaks */
            max-height: 300px;
            overflow-y: auto;
        }
        .gemini-response-container pre {
             white-space: pre-wrap;
             word-wrap: break-word;
        }
        .gemini-response-container .code-block-gemini {
            background-color: #1e1b4b; /* Indigo 950 */
            color: #e0e7ff;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            direction: ltr;
            text-align: left;
        }
         .gemini-response-container strong {
            color: #4c1d95; /* Violet 900 */
        }
        .gemini-response-container ul {
            list-style-type: disc;
            padding-right: 1.5rem;
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <div id="canvas-viewport">
            <svg id="connector-svg">
                <defs>
                    <linearGradient id="active-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#22c55e;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                    </linearGradient>
                </defs>
            </svg>
            <!-- Nodes will be injected here -->
        </div>
    </div>

    <div id="modal-container"></div>
    <div class="absolute top-4 right-4 bg-white p-2 rounded-lg shadow-md text-sm text-gray-600">גרור את הרקע כדי להזיז, גרור את הקלפים כדי לסדר</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const viewport = document.getElementById('canvas-viewport');
        const modalContainer = document.getElementById('modal-container');
        const connectorSvg = document.getElementById('connector-svg');

        let completionStatus = [];
        let nodes = [];

        const stepsData = [
            {
                id: 1,
                title: "יסודות: הקמת פרויקט ה-Hub",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>`,
                checklist: [
                    "יצירת פרויקט GCP חדש בשם `flowise-control-plane`.",
                    "קישור חשבון חיוב (Billing Account) לפרויקט.",
                    "הפעלת API: Compute Engine",
                    "הפעלת API: Network Connectivity",
                    "הפעלת API: Cloud Build & Artifact Registry",
                    "הפעלת API: Cloud Run & IAM",
                    "יצירת רשת VPC ייעודית (`hub-vpc`) עם Subnet.",
                    "הגדרת Network Connectivity Center (NCC) Hub גלובלי.",
                    "יצירת Service Account ייעודי עבור Flowise (`flowise-agent`)."
                ],
                guidance: `
                    <h3 class="text-xl font-semibold mb-2">שלב 1: בניית מגדל הפיקוח 🗼</h3>
                    <p class="mb-4">חשבו על פרויקט ה-Hub כמו מגדל פיקוח בשדה תעופה. זהו המקום המרכזי, המאובטח והמבודד שממנו ננהל את כל "הטיסות" (הפעולות) לשדות המשנה (פרויקטי ה-Spoke). בשלב זה, אנחנו מניחים את היסודות: יוצרים את הפרויקט, מפעילים את השירותים הנחוצים, בונים את "מסלול ההמראה" הפרטי (רשת ה-VPC), ומקימים את ליבת מערכת הקישוריות (NCC Hub).</p>
                    <svg viewBox="0 0 400 220" class="guidance-svg"><rect x="1" y="1" width="398" height="218" rx="15" fill="#f9fafb"></rect><rect x="125" y="20" width="150" height="70" rx="10" fill="#bfdbfe" stroke="#3b82f6" stroke-width="2"></rect><text x="200" y="50" text-anchor="middle" font-weight="bold">Hub Project</text><text x="200" y="70" text-anchor="middle" font-size="12px">VPC, NCC Hub, SA</text><path d="M 125 55 L 10 55" stroke="#9ca3af" stroke-dasharray="4"></path><text x="5" y="50" font-size="12px">זה הפרויקט שנבנה עכשיו</text><circle cx="200" cy="150" r="40" fill="#e0f2fe"></circle><text x="200" y="155" text-anchor="middle">🌐</text><text x="200" y="175" text-anchor="middle" font-size="10px">NCC Hub</text><circle cx="100" cy="150" r="30" fill="#eef2ff"></circle><text x="100" y="155" text-anchor="middle">💻</text><text x="100" y="170" text-anchor="middle" font-size="10px">Hub VPC</text><circle cx="300" cy="150" r="30" fill="#fef9c3"></circle><text x="300" y="155" text-anchor="middle">🔑</text><text x="300" y="170" text-anchor="middle" font-size="10px">Service Acct</text></svg>
                    <h3 class="text-xl font-semibold mb-2">מושגי מפתח</h3>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong>NCC Hub:</strong> שירות מנוהל של גוגל שפועל כמו נתב-על (Router) ומאפשר לחבר רשתות שונות תחת קורת גג אחת.</li>
                        <li><strong>Service Account:</strong> "תעודת הזהות" הדיגיטלית של Flowise. באמצעותו, Flowise יזדהה מול שירותי גוגל אחרים.</li>
                    </ul>
                `,
                terminalData: `# main.tf - Hub Project Configuration\nprovider "google" {\n  project = "flowise-control-plane"\n  region  = "us-central1"\n}\n\n# Enable necessary APIs\nresource "google_project_service" "apis" {\n  for_each = toset([\n    "compute.googleapis.com", "networkconnectivity.googleapis.com", "cloudbuild.googleapis.com",\n    "run.googleapis.com", "artifactregistry.googleapis.com", "iam.googleapis.com"\n  ])\n  service = each.key\n  disable_on_destroy = false\n}\n\n# Create a dedicated VPC and Subnet\nresource "google_compute_network" "hub_vpc" {\n  name = "hub-vpc"\n  auto_create_subnetworks = false\n}\nresource "google_compute_subnetwork" "hub_subnetwork" {\n  name          = "hub-subnetwork"\n  ip_cidr_range = "10.0.1.0/24"\n  network       = google_compute_network.hub_vpc.id\n  region        = "us-central1"\n}\n\n# Create the Network Connectivity Center Hub\nresource "google_network_connectivity_hub" "hub" {\n  name        = "main-control-hub"\n  description = "Central hub for connecting spoke projects"\n}\n\n# Create a dedicated Service Account for Flowise\nresource "google_service_account" "flowise_agent" {\n  account_id   = "flowise-agent"\n  display_name = "Flowise Control Plane Agent"\n}\n`
            },
            {
                id: 2,
                title: "החישורים: הגדרת פרויקט Spoke",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3m0 0l3-3m-3 3v8m0-13a9 9 0 110 18 9 9 0 010-18z" /></svg>`,
                checklist: [
                    "בחירת פרויקט Spoke קיים או יצירת חדש (למשל, `org-project-prod`).",
                    "הפעלת APIs נדרשים: Compute, Network Connectivity, Cloud Functions, IAM.",
                    "וידוא קיום VPC ו-Subnet בפרויקט.",
                    "יצירת קובץ ZIP עם קוד לדוגמה עבור Cloud Function (`list-vms`).",
                    "העלאת קוד ה-Function ל-Cloud Storage Bucket.",
                    "פריסת ה-Cloud Function עם הגדרת גישה פנימית בלבד (Internal Ingress).",
                    "יצירת 'הצעת חיבור' (NCC Spoke) מה-VPC של ה-Spoke אל ה-Hub המרכזי."
                ],
                guidance: `
                    <h3 class="text-xl font-semibold mb-2">שלב 2: חיבור שדות המשנה ✈️</h3>
                    <p class="mb-4">עכשיו, כשיש לנו מגדל פיקוח, אנחנו צריכים לחבר אליו את שדות התעופה הקיימים. כל פרויקט ארגוני (ייצור, פיתוח וכו') הוא "Spoke". בשלב זה, אנחנו נכנסים לכל פרויקט כזה ומתקינים בו "משדר" (NCC Spoke) שמציע להתחבר למגדל הפיקוח. בנוסף, אנחנו בונים "שרוול עליה למטוס" פנימי ומאובטח (Cloud Function) שיאפשר למגדל הפיקוח לתת הוראות לפעולות בתוך הפרויקט.</p>
                    <svg viewBox="0 0 400 200" class="guidance-svg"><rect x="1" y="1" width="398" height="198" rx="15" fill="#f9fafb"></rect><rect x="20" y="70" width="120" height="60" rx="10" fill="#dcfce7" stroke="#22c55e" stroke-width="2"></rect><text x="80" y="95" text-anchor="middle" font-weight="bold">Spoke Project</text><text x="80" y="110" text-anchor="middle" font-size="10px">VPC, Cloud Function</text><rect x="260" y="70" width="120" height="60" rx="10" fill="#bfdbfe" stroke="#3b82f6" stroke-width="2"></rect><text x="320" y="100" text-anchor="middle" font-weight="bold">Hub</text><path d="M140 100 H 260" stroke="#f59e0b" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrow-pending)"></path><text x="200" y="90" text-anchor="middle" font-size="12px" fill="#f59e0b">מציע חיבור...</text><defs><marker id="arrow-pending" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#f59e0b"></path></marker></defs></svg>
                    <h3 class="text-xl font-semibold mb-2">למה Cloud Function פנימי?</h3>
                    <p class="mb-4">הגדרת הגישה ל-Cloud Function כפנימית בלבד היא קריטית לאבטחה. זה אומר שרק שירותים אחרים בתוך הרשת הפרטית של גוגל יכולים לקרוא לו. כך אנו מבטיחים שרק Flowise (שנמצא בתוך הרשת) יוכל להפעיל פעולות, ואף גורם חיצוני לא יוכל לגשת ל-API הניהולי שלנו.</p>
                `,
                terminalData: `# main.tf - Spoke Project Configuration\nprovider "google" {\n  alias   = "spoke"\n  project = "org-project-prod"\n  region  = "us-central1"\n}\n\n# Data source for existing VPC\ndata "google_compute_network" "spoke_vpc" {\n  provider = google.spoke\n  name     = "spoke-vpc-prod" # Make sure this VPC exists\n}\n\n# Sample Cloud Function\n# NOTE: The source code needs to be created and uploaded to a bucket separately.\nresource "google_cloudfunctions_function" "list_vms" {\n  provider = google.spoke\n  name     = "list-vms-function"\n  runtime  = "nodejs16"\n  source_archive_bucket = "source-code-bucket-prod"\n  source_archive_object = "source.zip"\n  entry_point           = "listVMs"\n  trigger_http          = true\n  ingress_settings      = "ALLOW_INTERNAL_ONLY"\n}\n\n# Propose a connection from this Spoke's VPC to the Hub\nresource "google_network_connectivity_spoke" "prod_spoke_connection" {\n  provider    = google.spoke\n  name        = "prod-spoke-to-hub"\n  location    = "global"\n  hub         = "projects/flowise-control-plane/locations/global/hubs/main-control-hub"\n  linked_vpc_network {\n    uri = data.google_compute_network.spoke_vpc.self_link\n  }\n}\n`
            },
            {
                id: 3,
                title: "לחיצת היד: אישור והרשאות",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>`,
                checklist: [
                    "בפרויקט ה-Hub, אישור הצעת החיבור של ה-Spoke.",
                    "וידוא שהחיבור עבר למצב 'ACTIVE' בשני הפרויקטים.",
                    "בפרויקט ה-Spoke, הענקת הרשאת `roles/cloudfunctions.invoker` ל-SA של Flowise.",
                    "בפרויקט ה-Spoke, הענקת הרשאת `roles/compute.viewer` ל-SA של Flowise."
                ],
                guidance: `
                    <h3 class="text-xl font-semibold mb-2">שלב 3: חתימת ההסכם 🤝</h3>
                    <p class="mb-4">הצעת החיבור מה-Spoke היא רק צד אחד במשוואה. עכשיו, מנהל מגדל הפיקוח (בפרויקט ה-Hub) צריך לאשר את הבקשה. זהו מנגנון אבטחה חשוב שנקרא "הסכמה הדדית". לאחר לחיצת היד הרשתית, אנחנו חותמים על "הסכם הרשאות" (IAM Policy) שמגדיר בדיוק מה מותר ל-Flowise לעשות בתוך ה-Spoke. בלי שני החלקים האלה, אין תקשורת.</p>
                    <svg viewBox="0 0 400 200" class="guidance-svg"><rect x="1" y="1" width="398" height="198" rx="15" fill="#f9fafb"></rect><rect x="20" y="70" width="120" height="60" rx="10" fill="#dcfce7" stroke="#22c55e" stroke-width="2"></rect><text x="80" y="100" text-anchor="middle" font-weight="bold">Spoke</text><rect x="260" y="70" width="120" height="60" rx="10" fill="#bfdbfe" stroke="#3b82f6" stroke-width="2"></rect><text x="320" y="100" text-anchor="middle" font-weight="bold">Hub</text><path d="M140 100 H 260" stroke="#22c55e" stroke-width="2.5" marker-end="url(#arrow-active)" marker-start="url(#arrow-active)"></path><text x="200" y="90" text-anchor="middle" font-size="12px" fill="#166534">מחובר!</text><path d="M80 70 C 80 -10, 320 -10, 320 70" stroke="#a78bfa" stroke-width="2" fill="none" stroke-dasharray="4"></path><text x="200" y="25" text-anchor="middle" font-size="12px" fill="#5b21b6">IAM Permissions</text><defs><marker id="arrow-active" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#22c55e"></path></marker></defs></svg>
                    <h3 class="text-xl font-semibold mb-2">עקרון ההרשאה המינימלית (Least Privilege)</h3>
                    <p class="mb-4">אנחנו לא נותנים ל-Flowise מפתח מאסטר לכל הפרויקט. אנחנו נותנים לו שני מפתחות ספציפיים בלבד: אחד שמאפשר לו "ללחוץ על הכפתור" של ה-Cloud Function, ואחד שמאפשר לו "להסתכל" על רשימת המכונות. זה מבטיח שאם חשבון השירות ייפרץ, הנזק יהיה מוגבל.</p>
                `,
                terminalData: `# 1. Accept the spoke connection (RUN FROM HUB PROJECT)\ngcloud network-connectivity spokes accept prod-spoke-to-hub --hub=main-control-hub --location=global --project=flowise-control-plane\n\n# 2. Grant invoker permissions (RUN FROM SPOKE PROJECT)\ngcloud functions add-iam-policy-binding list-vms-function --member="serviceAccount:flowise-agent@flowise-control-plane.iam.gserviceaccount.com" --role="roles/cloudfunctions.invoker" --project=org-project-prod --region=us-central1\n\n# 3. Grant compute viewer permissions (RUN FROM SPOKE PROJECT)\ngcloud projects add-iam-policy-binding org-project-prod --member="serviceAccount:flowise-agent@flowise-control-plane.iam.gserviceaccount.com" --role="roles/compute.viewer"\n`
            },
            {
                id: 4,
                title: "המוח: פריסת Flowise ל-Cloud Run",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c.251-.146.52-.268.797-.362l.558-.175a2.25 2.25 0 012.087.218l4.113 2.533a2.25 2.25 0 01.928 2.148l-.69 3.398a2.25 2.25 0 01-2.148.928l-3.398-.69a2.25 2.25 0 01-2.148-2.148V3.104z" /></svg>`,
                checklist: [
                    "יצירת מאגר Docker ב-Artifact Registry.",
                    "בניית Docker image של Flowise והעלאתו למאגר.",
                    "הקמת Serverless VPC Access connector.",
                    "פריסת שירות Cloud Run חדש מה-image.",
                    "שיוך ה-Service Account הייעודי (`flowise-agent`).",
                    "חיבור ה-Cloud Run לרשת ה-`hub-vpc` דרך ה-VPC connector.",
                    "הגדרת גישה נכנסת (Ingress) ל-`Internal` בלבד."
                ],
                guidance: `
                    <h3 class="text-xl font-semibold mb-2">שלב 4: התקנת מערכת ההפעלה 🧠</h3>
                    <p class="mb-4">עכשיו כשהתשתיות מוכנות, הגיע הזמן להתקין את "המוח" של המערכת - Flowise. אנחנו עושים זאת באמצעות Cloud Run, שירות המאפשר לנו להריץ את האפליקציה בלי לדאוג לשרתים. התהליך כולל אריזה של Flowise בקופסה סטנדרטית (Docker), העלאת הקופסה למחסן (Artifact Registry), ופריסתה בסביבה מנוהלת ומאובטחת. החלק הקריטי כאן הוא חיבור ה-Cloud Run לרשת הפרטית שלנו, כך שהוא יוכל "לראות" את ה-Spokes.</p>
                     <svg viewBox="0 0 400 200" class="guidance-svg"><rect x="1" y="1" width="398" height="198" rx="15" fill="#f9fafb"></rect><rect x="150" y="20" width="100" height="60" rx="10" fill="#fffbeb" stroke="#f59e0b" stroke-width="2"></rect><text x="200" y="55" text-anchor="middle" font-weight="bold">Cloud Run</text><path d="M 200 80 V 120" stroke="#3b82f6" stroke-width="2"></path><rect x="20" y="120" width="360" height="60" rx="10" fill="#eef2ff" stroke="#4338ca" stroke-width="2"></rect><text x="200" y="155" text-anchor="middle" font-weight="bold">Hub VPC</text><text x="350" y="140" text-anchor="middle" font-size="12px">אל ה-Spokes</text><path d="M330 150 H 380" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrow-blue)"></path><defs><marker id="arrow-blue" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6"></path></marker></defs></svg>
                    <h3 class="text-xl font-semibold mb-2">למה Cloud Run?</h3>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong>Serverless:</strong> אין צורך לנהל שרתים, מערכות הפעלה או עדכונים.</li>
                        <li><strong>Scalability:</strong> המערכת גדלה וקטנה אוטומטית לפי הצורך, ויכולה לרדת לאפס כדי לחסוך כסף.</li>
                        <li><strong>Security:</strong> הפריסה כ-"Internal" מבודדת את הממשק מהאינטרנט הציבורי.</li>
                    </ul>
                `,
                terminalData: `# 1. Create Artifact Registry repository\ngcloud artifacts repositories create flowise-repo --repository-format=docker --location=us-central1 --project=flowise-control-plane\n\n# 2. Build and push image\ngcloud builds submit --tag us-central1-docker.pkg.dev/flowise-control-plane/flowise-repo/flowise:latest . --project=flowise-control-plane\n\n# 3. Create VPC Connector\ngcloud compute networks vpc-access connectors create hub-vpc-connector --network=hub-vpc --region=us-central1 --range=10.8.0.0/28 --project=flowise-control-plane\n\n# 4. Deploy Flowise to Cloud Run\ngcloud run deploy flowise-control-plane --image="us-central1-docker.pkg.dev/flowise-control-plane/flowise-repo/flowise:latest" --service-account="flowise-agent@flowise-control-plane.iam.gserviceaccount.com" --vpc-connector="hub-vpc-connector" --vpc-egress="all-traffic" --ingress="internal" --allow-unauthenticated --project=flowise-control-plane --region=us-central1\n`
            },
            {
                id: 5,
                title: "אינטגרציה ושימוש",
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>`,
                checklist: [
                    "גישה לממשק ה-UI של Flowise (דרך IAP או VM בתוך רשת ה-Hub).",
                    "בניית Chatflow חדש והוספת Agent.",
                    "יצירת 'Custom Tool' עם קוד JavaScript לביצוע קריאות מאומתות.",
                    "הטמעת הלוגיקה לקבלת Identity Token עבור ה-Cloud Function.",
                    "ביצוע קריאת `fetch` ל-URL הפנימי של ה-Cloud Function.",
                    "חיבור הכלי לסוכן ובדיקה מקצה לקצה."
                ],
                guidance: `
                    <h3 class="text-xl font-semibold mb-2">שלב 5: הפעלה ותקשורת 💬</h3>
                    <p class="mb-4">הכל מוכן, ועכשיו מגיע החלק המהנה: לגרום למערכת לדבר. אנחנו ניגש לממשק של Flowise ונבנה זרימת שיחה פשוטה. הלב של זרימה זו הוא "כלי מותאם אישית" (Custom Tool) שנכתוב. הכלי הזה הוא פיסת קוד JavaScript שמשמשת כמתרגם: היא לוקחת בקשה בשפה טבעית (כמו "הצג לי מכונות בפרויקט X"), משיגה "אישור כניסה" חד-פעמי ומאובטח (Identity Token), ומשתמשת בו כדי לקרוא ל-Cloud Function המתאים בפרויקט היעד דרך הרשת הפרטית.</p>
                    <h3 class="text-xl font-semibold mb-2">איך האימות עובד?</h3>
                    <p class="mb-4">הקוד שלנו משתמש בספריית האימות של גוגל. מכיוון שהקוד רץ בסביבת Cloud Run המשויכת ל-Service Account, הוא יכול לבקש אוטומטית 'Identity Token' מהשירותים הפנימיים של גוגל. זהו טוקן קריפטוגרפי שמוכיח לשירות המקבל (ה-Cloud Function) שהקריאה הגיעה ממקור מורשה. זה מאובטח, אוטומטי, ולא דורש ניהול מפתחות.</p>
                `,
                terminalData: `// Example JavaScript code for a Flowise Custom Tool\n// This code runs inside the Flowise environment\n\nconst { GoogleAuth } = require('google-auth-library');\n\n// Input variables from the Chatflow (e.g., $projectId)\nconst targetProjectId = $projectId; \nconst region = 'us-central1';\nconst functionName = 'list-vms-function';\n\n// --- Main logic ---\ntry {\n    // 1. Construct the secure, internal URL of the target Cloud Function\n    const functionUrl = \`https://\${region}-\${targetProjectId}.cloudfunctions.net/\${functionName}\`;\n\n    // 2. Initialize Google Auth. It automatically finds credentials \n    // from the environment (the attached Service Account).\n    const auth = new GoogleAuth();\n    \n    // 3. Get an OIDC identity token for the target function's URL.\n    const client = await auth.getIdTokenClient(functionUrl);\n    \n    // 4. Make an authenticated request using the generated token.\n    const response = await client.request({ url: functionUrl });\n    \n    // 5. Return the data received from the Cloud Function.\n    return JSON.stringify(response.data, null, 2);\n\n} catch (error) {\n    console.error('Error invoking Cloud Function:', error);\n    if (error.response) {\n        return \`Error: \${error.response.status} \${error.response.statusText}\`;\n    }\n    return \`Error: \${error.message}\`;\n}\n`
            }
        ];

        async function callGemini(prompt, responseElement) {
            const loadingSpinner = `<div class="flex justify-center items-center gap-2 text-gray-500"><svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Gemini חושב...</span></div>`;
            responseElement.innerHTML = loadingSpinner;
            responseElement.style.display = 'block';

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            let response;
            let retries = 3;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            let text = candidate.content.parts[0].text;
                            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                            text = text.replace(/\n\s*(\*|-)\s/g, '<br>• ');
                            text = text.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre class="code-block-gemini"><code>$2</code></pre>');
                            text = text.replace(/`([^`]+)`/g, '<code class="bg-violet-200 text-violet-800 px-1 rounded">$1</code>');
                            text = text.replace(/\n/g, '<br>');

                            responseElement.innerHTML = text;
                            return;
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        continue;
                    }
                    break;
                } catch (error) {
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                    continue;
                }
            }

            responseElement.innerHTML = '<p class="text-red-500">שגיאה בתקשורת עם Gemini API. נסה שוב מאוחר יותר.</p>';
        }


        // --- Canvas Panning & Dragging Logic ---
        let isPanning = false;
        let startPos = { x: 0, y: 0 };
        let translatePos = { x: window.innerWidth / 2 - 200, y: 150 };

        function applyTransform() {
            viewport.style.transform = `translate(${translatePos.x}px, ${translatePos.y}px)`;
        }

        document.getElementById('canvas-container').addEventListener('mousedown', (e) => {
            if (e.target.closest('.step-node')) return;
            isPanning = true;
            startPos = { x: e.clientX, y: e.clientY };
            document.getElementById('canvas-container').style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            const dx = e.clientX - startPos.x;
            const dy = e.clientY - startPos.y;
            translatePos.x += dx;
            translatePos.y += dy;
            startPos = { x: e.clientX, y: e.clientY };
            applyTransform();
        });

        document.addEventListener('mouseup', () => {
            isPanning = false;
            document.getElementById('canvas-container').style.cursor = 'grab';
        });

        // --- Node & Pipeline Logic ---
        function renderPipeline() {
            viewport.innerHTML = '<svg id="connector-svg"><defs><linearGradient id="active-gradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#22c55e;stop-opacity:1" /><stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" /></linearGradient></defs></svg>'; // Clear and add back svg

            stepsData.forEach((step, index) => {
                completionStatus[index] = completionStatus[index] || false;

                const nodeEl = document.createElement('div');
                nodeEl.className = 'step-node';
                nodeEl.id = `step-node-${step.id}`;
                nodeEl.style.left = `${100 + index * 450}px`;
                nodeEl.style.top = '50px';

                nodeEl.innerHTML = `
                    <div class="step-header">
                        <div class="step-title-section">
                            <div class="step-icon">${step.icon}</div>
                            <div>
                                <h2 class="step-title">${step.title}</h2>
                                <p class="text-gray-500 text-sm">שלב ${step.id} מתוך ${stepsData.length}</p>
                            </div>
                        </div>
                        <span class="step-status status-pending" id="status-${step.id}">ממתין</span>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center gap-4"><span class="text-sm font-medium text-gray-600">התקדמות:</span><div class="progress-bar-container flex-1"><div class="progress-bar" id="progress-${step.id}"></div></div></div>
                        <div class="checklist-container space-y-2 max-h-40 overflow-y-auto pr-2">
                            ${step.checklist.map((item, i) => `<div class="checklist-item"><input type="checkbox" id="check-${step.id}-${i}" data-step-id="${step.id}"><label for="check-${step.id}-${i}" class="text-gray-700">${item}</label></div>`).join('')}
                        </div>
                        <div class="step-actions">
                            <button class="action-btn btn-guidance" data-modal="guidance-${step.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>הדרכה והסבר</button>
                            <button class="action-btn btn-terminal" data-modal="terminal-${step.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 2.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>משימת סוכן</button>
                        </div>
                        <button id="complete-btn-${step.id}" class="action-btn btn-complete mt-4" disabled>סמן כהושלם</button>
                    </div>`;
                viewport.appendChild(nodeEl);
                nodes.push(nodeEl);

                modalContainer.innerHTML += `
                    <div id="guidance-${step.id}" class="modal-overlay">
                        <div class="modal-content">
                            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" data-close>✖</button>
                            <h2 class="modal-header">${step.title} - הדרכה</h2>
                            <div>${step.guidance}</div>
                             <div class="gemini-section">
                                <h3 class="gemini-title">✨ Gemini Helper</h3>
                                <div class="flex gap-2 mt-2">
                                    <button class="gemini-btn" data-step-id="${step.id}" data-action="explain-simple">הסבר פשוט</button>
                                    <button class="gemini-btn" data-step-id="${step.id}" data-action="explain-deep">ניתוח טכני</button>
                                </div>
                                <div class="gemini-response-container"></div>
                            </div>
                        </div>
                    </div>
                    <div id="terminal-${step.id}" class="modal-overlay">
                        <div class="modal-content !bg-[#1f2937] text-white">
                            <button class="absolute top-4 right-4 text-gray-400 hover:text-white" data-close>✖</button>
                            <h2 class="modal-header">${step.title} - Agent Task</h2>
                            <div class="gemini-section !border-gray-600 !pt-0 mb-4">
                                <h3 class="gemini-title !text-violet-300">✨ Gemini Helper</h3>
                                <div class="flex gap-2 mt-2">
                                     <button class="gemini-btn" data-step-id="${step.id}" data-action="add-comments">הוסף הערות לקוד</button>
                                     <button class="gemini-btn" data-step-id="${step.id}" data-action="troubleshoot">פתרון תקלות</button>
                                </div>
                                <div class="gemini-response-container !bg-gray-800 !border-gray-700"></div>
                            </div>
                            <div class="code-block">
                                <button class="copy-btn" title="העתק קוד"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>
                                <pre><code>${step.terminalData}</code></pre>
                            </div>
                        </div>
                    </div>
                `;
            });

            const connectorSvgEl = document.getElementById('connector-svg');
            for(let i = 0; i < nodes.length - 1; i++){
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('class', 'connector-path');
                path.setAttribute('id', `connector-${i+1}`);
                connectorSvgEl.appendChild(path);
            }

            addEventListeners();
            updateConnectors();
            updateUI();
        }

        function updateConnectors() {
            for(let i = 0; i < nodes.length - 1; i++){
                const path = document.getElementById(`connector-${i+1}`);
                if(!path) continue;

                const nodeA = nodes[i];
                const nodeB = nodes[i+1];

                const rectA = nodeA.getBoundingClientRect();
                const rectB = nodeB.getBoundingClientRect();
                const viewportRect = viewport.getBoundingClientRect();

                const startX = (rectA.right - viewportRect.left);
                const startY = (rectA.top - viewportRect.top) + rectA.height / 2;
                const endX = (rectB.left - viewportRect.left);
                const endY = (rectB.top - viewportRect.top) + rectB.height / 2;

                const d = `M ${startX} ${startY} C ${startX + 75} ${startY}, ${endX - 75} ${endY}, ${endX} ${endY}`;
                path.setAttribute('d', d);
            }
        }

        function showSuccessStep() {
            const lastNode = nodes[nodes.length - 1];
            const finalNode = document.createElement('div');
            finalNode.className = 'step-node step-node-final active';
            finalNode.style.left = `${parseInt(lastNode.style.left) + 450}px`;
            finalNode.style.top = `${parseInt(lastNode.style.top)}px`;
            finalNode.innerHTML = `<div class="step-icon mx-auto !bg-green-500 !w-16 !h-16"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></div><h2 class="text-2xl font-bold mt-4">ההקמה הושלמה בהצלחה!</h2><p class="text-gray-600 mt-2">יצרת בהצלחה Control Plane מאובטח. כעת ניתן להתחיל לנהל את פרויקטי ה-Spoke שלך מממשק שיחה מרכזי אחד.</p>`;
            viewport.appendChild(finalNode);
            nodes.push(finalNode);

            const connectorSvgEl = document.getElementById('connector-svg');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', 'connector-path active');
            path.setAttribute('id', `connector-${nodes.length-1}`);
            connectorSvgEl.appendChild(path);

            updateConnectors();
        }

        function updateUI() {
            let allCompleted = true;
            stepsData.forEach((step, index) => {
                const node = document.getElementById(`step-node-${step.id}`);
                const statusEl = document.getElementById(`status-${step.id}`);
                const completeBtn = document.getElementById(`complete-btn-${step.id}`);
                const connector = document.getElementById(`connector-${step.id}`);

                node.classList.remove('active', 'completed');
                if(connector) connector.classList.remove('active');

                if (completionStatus[index]) {
                    node.classList.add('completed');
                    statusEl.textContent = 'הושלם';
                    statusEl.className = 'step-status status-completed';
                    completeBtn.textContent = 'הושלם ✔';
                    completeBtn.disabled = true;
                    completeBtn.classList.add('ready');

                    if(connector) connector.classList.add('active');
                } else {
                    allCompleted = false;
                }
            });

            const activeIndex = completionStatus.findIndex(s => !s);
            if (activeIndex !== -1) {
                const activeStep = stepsData[activeIndex];
                document.getElementById(`step-node-${activeStep.id}`).classList.add('active');
                document.getElementById(`status-${activeStep.id}`).textContent = 'בתהליך';
                document.getElementById(`status-${activeStep.id}`).className = 'step-status status-active';
                const activeConnector = document.getElementById(`connector-${activeStep.id}`);
                if (activeConnector) activeConnector.classList.add('active');

            } else if (allCompleted && nodes.length === stepsData.length) {
                showSuccessStep();
            }
        }

        function updateProgress(stepId) {
            const checkboxes = document.querySelectorAll(`input[data-step-id="${stepId}"]`);
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const total = checkboxes.length;
            const percentage = total > 0 ? (checkedCount / total) * 100 : 0;

            document.getElementById(`progress-${stepId}`).style.width = `${percentage}%`;

            const completeBtn = document.getElementById(`complete-btn-${stepId}`);
            if(percentage === 100) {
                completeBtn.disabled = false;
                completeBtn.classList.add('ready');
                completeBtn.textContent = 'סמן כהושלם';
            } else {
                completeBtn.disabled = true;
                completeBtn.classList.remove('ready');
                completeBtn.textContent = 'סמן כהושלם';
            }
        }

        function addEventListeners() {
            // Modals
            document.querySelectorAll('[data-modal]').forEach(button => button.addEventListener('click', () => document.getElementById(button.getAttribute('data-modal')).classList.add('visible')));
            document.querySelectorAll('[data-close], .modal-overlay').forEach(el => el.addEventListener('click', (e) => { if (e.target.closest('[data-close]') || e.target === el) el.closest('.modal-overlay').classList.remove('visible'); }));

            // Checklists
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.addEventListener('change', (e) => updateProgress(e.target.dataset.stepId)));

            // Complete buttons
            stepsData.forEach((step, index) => {
                document.getElementById(`complete-btn-${step.id}`).addEventListener('click', () => { completionStatus[index] = true; updateUI(); });
                updateProgress(step.id);
            });

            // Copy buttons
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const pre = e.currentTarget.parentElement.querySelector('pre');
                    navigator.clipboard.writeText(pre.innerText);
                    const originalHTML = e.currentTarget.innerHTML;
                    e.currentTarget.innerHTML = 'הועתק!';
                    setTimeout(() => { e.currentTarget.innerHTML = originalHTML; }, 2000);
                });
            });

            // Gemini buttons
            document.querySelectorAll('.gemini-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const stepId = e.target.dataset.stepId;
                    const action = e.target.dataset.action;
                    const step = stepsData.find(s => s.id == stepId);
                    const responseContainer = e.target.closest('.gemini-section').querySelector('.gemini-response-container');

                    let prompt = '';

                    switch(action) {
                        case 'explain-simple':
                            prompt = `You are a helpful assistant who explains complex technical topics in a simple, easy-to-understand way. Explain the following concept about Google Cloud Platform as if you were talking to a complete beginner who has no experience with cloud computing. Use simple analogies and avoid jargon. The concept is:\n\n---\n${step.guidance}`;
                            break;
                        case 'explain-deep':
                            prompt = `You are an expert Google Cloud Architect. Provide a technical deep-dive on the following Google Cloud Platform concept. Go beyond the surface-level explanation. Mention specific technical details, potential alternatives or competing services, best practices for production environments, and common pitfalls. The concept is:\n\n---\n${step.guidance}`;
                            break;
                        case 'add-comments':
                            prompt = `You are a senior software engineer who writes excellent, clear documentation. Add detailed, line-by-line comments to the following code snippet. Explain the purpose and 'why' of each command or block of code, not just the 'what'. If it's a Terraform file, explain the resources being created. If it's a shell script, explain the commands and their flags. The final output should be only the commented code block, enclosed in a single markdown code block. The code is:\n\n---\n\`\`\`\n${step.terminalData}\n\`\`\``;
                            break;
                        case 'troubleshoot':
                            prompt = `You are a Google Cloud support engineer specializing in debugging infrastructure issues. I am at the following step in a GCP setup guide:\n\nStep Title: "${step.title}"\n\nThe code for this step is:\n\`\`\`\n${step.terminalData}\n\`\`\`\n\nList 3 to 5 common errors or problems a user might face *at this specific step*. For each problem, provide a clear 'Symptom', a 'Likely Cause', and a 'Solution'. The solution should be actionable and include any necessary \`gcloud\` or \`terraform\` commands for debugging or fixing the issue. Format the output using Markdown with clear headings for each problem.`;
                            break;
                    }

                    if (prompt) {
                        callGemini(prompt, responseContainer);
                    }
                });
            });


            // Node dragging
            nodes.forEach(node => {
                let isDragging = false;
                let dragStart = {x: 0, y: 0};
                let nodeStart = {x: 0, y: 0};

                node.addEventListener('mousedown', e => {
                    if (e.target.closest('input, label, button')) return;
                    isDragging = true;
                    node.classList.add('dragging');
                    dragStart = { x: e.clientX, y: e.clientY };
                    nodeStart = { x: parseInt(node.style.left), y: parseInt(node.style.top) };
                    e.preventDefault();
                });

                document.addEventListener('mousemove', e => {
                    if (!isDragging) return;
                    const dx = e.clientX - dragStart.x;
                    const dy = e.clientY - dragStart.y;
                    node.style.left = `${nodeStart.x + dx}px`;
                    node.style.top = `${nodeStart.y + dy}px`;
                    updateConnectors();
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    node.classList.remove('dragging');
                });
            });

            window.addEventListener('resize', updateConnectors);
        }

        renderPipeline();
        applyTransform();
    });
    </script>
</body>
</html>

